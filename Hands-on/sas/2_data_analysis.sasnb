[{"kind":1,"language":"markdown","value":"## Data Analysis\nIn this section we will deeper explore the data. We will start by creating an hypothesis around which variables are likely to predict defaults. We will investigate the correlations between them and we will visualize them in a scatter plot through dimensionality reduction. Finally, we will explore the presence of clusters and how they are characterized.  \n\nHere are the steps:\n1. Correlation analysis\n2. Dimensionality reduction\n3. Cluster analysis","outputs":[]},{"kind":1,"language":"markdown","value":"### Correlations between target and feature variables\nExplore the correlations between numerical variables. Do you believe they are correct? What are the strongest and weakest relationships?\n![Correlation Overview](../../img/Corr_Overview.png)\n\nDocumentation link: https://go.documentation.sas.com/doc/en/workbenchcdc/v_001/procstat/procstat_corr_overview.htm","outputs":[]},{"kind":2,"language":"sas","value":"* Write the code to create a correlation matrix of the target and relevant feature variables;\nproc corr data = wbdata.&explorationData. out=work.correlations;\n    var ;\nrun;","outputs":[]},{"kind":2,"language":"sas","value":"* Code to prepare data for correlation matrix plot;\ndata work.correlations_plot;\n  keep x y r;\n  set work.correlations;\n  if _TYPE_='CORR';\n  array v{*} _numeric_;\n  x = _NAME_;\n  do i = dim(v) to 1 by -1;\n    y = vname(v(i));\n    r = v(i);\n    output;\n  end;\nrun;\n\n* Define a color template to create a heatmap;\nproc template;\n  define statgraph corrHeatmap;\n  dynamic _Title;\n  begingraph;\n  entrytitle _Title;\n  rangeattrmap name='map';\n  range -1 - 1 / rangecolormodel=(cxe34a33 cxF5F5F5 cx3182BD);\n      endrangeattrmap;\n      rangeattrvar var=r attrvar=r attrmap='map';\n      layout overlay /\n      xaxisopts=(display=(line ticks tickvalues))\n      yaxisopts=(display=(line ticks tickvalues));\n      heatmapparm x = x y = y colorresponse = r /\n          xbinaxis=false ybinaxis=false\n          name = \"heatmap\" display=all;\n          continuouslegend \"heatmap\" /\n          orient = vertical location = outside title=\"Pearson Correlation\";\n          endlayout;\n    endgraph;\n  end;\nrun;","outputs":[]},{"kind":2,"language":"sas","value":"proc sgrender data=work.correlations_plot template=corrHeatmap;\n     dynamic _title=\"Corr matrix\";\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"### Dimensionality reduction with PROC TSNE\nThe TSNE procedure implements the t-distributed stochastic neighbor embedding (t-SNE), a method well suited for: visualizing high-dimensional data, feature engineering and preprocessing for subsequent clustering and modelling. PROC TSNE computes a low-dimensional representation, also called an embedding, of high-dimensional data into two or three dimensions. Unlike other dimension reduction methods, such as principal component analysis, t-SNE is appropriate for nonlinear data and emphasizes existing groupings in the data.\n\nThe TSNE procedure operates on an input data table. For each observation in the input data table, the procedure returns either two or three computed columns that contain the embedding coordinates. It computes the embedding by minimizing the Kullback-Leibler divergence between the joint probabilities in high dimensions and the joint probabilities in low dimensions, and it stores the embedding in the output data table that is specified by the OUTPUT statement. To speed up computations, PROC TSNE uses the Barnes-Hut approximation to the perplexity loss.\n\nPerform TSNE for dimensionality reduction on a set of variables you believe to be useful for clustering and plot the results in a scatter plot.\n![TSNE Overview](../../img/TSNE_Proc_Overview.png)\n\nDocumentation link: https://go.documentation.sas.com/doc/en/workbenchcdc/v_001/vwbcasml/vwbcasml_tsne_toc.htm","outputs":[]},{"kind":2,"language":"sas","value":"* Perform dimensionality reduction;\nproc tsne data = wbdata.&explorationData.\n    ndimensions= 2\n    maxiters= 200\n    seed = 42\n    learningrate = 1000\n    method = BARNES_HUT;*DO NOT edit tsne parameters;\n    input FICOScore DebtIncRatio CreditLineAge LogAnnualInc InterestRate;   /* Try changing the input variables */ \n    output out = work.tsne_out copyvars=(CustomerID Default);","outputs":[]},{"kind":2,"language":"sas","value":"*Plot the TSNE Embeddings;\nproc sgplot data=tsne_out;\n   title \"TSNE embeddings\";\n   scatter x=_DIM_1_ y=_DIM_2_ / group=Default\n                                 markerattrs=(symbol=CircleFilled)\n                                 transparency=0.7;\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"### Cluster analysis\nPerform K-Means clustering on the data. What kind of customer segments can you identify?\n\n![KClust Overview](../../img/KClust_Proc_Overview.png)\n![KClust Params](../../img/KClust_Proc_Params.png)\n\nDocumentation link: https://go.documentation.sas.com/doc/en/workbenchcdc/v_001/vwbcasstat/vwbcasstat_kclus_overview.htm","outputs":[]},{"kind":2,"language":"sas","value":"*Apply K-Means Clustering and save the scored data to work.clustered_data;\n*Note: make sure to add in copyvar all the variables you are using for clustering;\n*IMPORTANT: Use the same set of variables used in TSNE;\nproc kclus data=wbdata.&explorationData. \n    noc=abc \n    maxclusters=20 \n    maxiter=100\n    seed=42;\n    input FICOScore DebtIncRatio CreditLineAge LogAnnualInc InterestRate;\n    score out=work.clustered_data copyvar=(CustomerID FICOScore DebtIncRatio CreditLineAge LogAnnualInc InterestRate default);\nrun;","outputs":[]},{"kind":2,"language":"sas","value":"*Join TSNE Embeddings with Clustering Data;\nproc sql;\n    create table work.clustered_tsne as \n    select *\n    from clustered_data clust join tsne_out tsne on clust.customerid = tsne.customerid\n;quit;\n\nproc print data = clustered_tsne(obs=2);\nrun;","outputs":[]},{"kind":2,"language":"sas","value":"*Plot Clustered Data;\nproc sgplot data=clustered_tsne;\n   title \"TSNE Clustered Embeddings\";\n   scatter x=_DIM_1_ y=_DIM_2_ / group=_CLUSTER_ID_\n                                 markerattrs=(symbol=CircleFilled)\n                                 transparency=0.7;\nrun;","outputs":[]},{"kind":2,"language":"sas","value":"*Analyze Descriptive Statistics for each Cluster;\nproc sort data = clustered_tsne;\n    by _cluster_id_;\nrun;\n\nproc means data = clustered_tsne;\n    var FICOScore DebtIncRatio CreditLineAge LogAnnualInc InterestRate default;\n    by _cluster_id_;\nrun;","outputs":[]}]